package com.atomguard.velocity.module.exploit;

import java.util.Map;
import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * Sunucu değiştirme kötüye kullanımı tespiti.
 */
public class ServerSwitchAbuse {

    private final Map<UUID, SwitchData> switchData = new ConcurrentHashMap<>();
    private final int maxSwitchesPerMinute;

    public ServerSwitchAbuse(int maxSwitchesPerMinute) {
        this.maxSwitchesPerMinute = maxSwitchesPerMinute;
    }

    public boolean allowSwitch(UUID playerId) {
        long now = System.currentTimeMillis();
        SwitchData data = switchData.compute(playerId, (k, v) -> {
            if (v == null || now - v.windowStart() > 60_000L)
                return new SwitchData(now, new AtomicInteger(1));
            v.count().incrementAndGet();
            return v;
        });
        return data.count().get() <= maxSwitchesPerMinute;
    }

    public int getSwitchCount(UUID playerId) {
        SwitchData data = switchData.get(playerId);
        return data != null ? data.count().get() : 0;
    }

    public void onPlayerLeave(UUID playerId) { switchData.remove(playerId); }

    public void cleanup() {
        long cutoff = System.currentTimeMillis() - 60_000L;
        switchData.entrySet().removeIf(e -> e.getValue().windowStart() < cutoff);
    }

    private record SwitchData(long windowStart, AtomicInteger count) {}
}
