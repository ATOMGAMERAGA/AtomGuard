package com.atomguard.velocity.module.exploit;

import com.atomguard.velocity.module.antiddos.RateLimiter;

import java.util.Map;
import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;

/**
 * Sohbet spam tespiti - hız sınırlama ve tekrar mesaj tespiti.
 */
public class ChatSpamDetector {

    private final RateLimiter rateLimiter;
    private final Map<UUID, String> lastMessages = new ConcurrentHashMap<>();
    private final Map<UUID, Integer> repeatCounts = new ConcurrentHashMap<>();
    private final int maxRepeats;

    public ChatSpamDetector(int maxMessagesPerSecond, int maxRepeats) {
        this.rateLimiter = new RateLimiter(maxMessagesPerSecond * 3, maxMessagesPerSecond);
        this.maxRepeats = maxRepeats;
    }

    public SpamCheckResult check(UUID playerId, String message) {
        if (!rateLimiter.tryAcquire(playerId.toString()))
            return new SpamCheckResult(SpamType.RATE_LIMIT, "Çok hızlı mesaj gönderimi");

        String last = lastMessages.put(playerId, message);
        if (message.equals(last)) {
            int count = repeatCounts.merge(playerId, 1, Integer::sum);
            if (count >= maxRepeats)
                return new SpamCheckResult(SpamType.REPEAT, "Tekrarlayan mesaj: " + count + " kez");
        } else {
            repeatCounts.remove(playerId);
        }

        return new SpamCheckResult(SpamType.NONE, "ok");
    }

    public void onPlayerLeave(UUID playerId) {
        lastMessages.remove(playerId);
        repeatCounts.remove(playerId);
        rateLimiter.reset(playerId.toString());
    }

    public void cleanup() { rateLimiter.cleanup(); }

    public enum SpamType { NONE, RATE_LIMIT, REPEAT }
    public record SpamCheckResult(SpamType type, String reason) {
        public boolean isSpam() { return type != SpamType.NONE; }
    }
}
