package com.atomguard.velocity.module.exploit;

import com.atomguard.velocity.AtomGuardVelocity;
import com.atomguard.velocity.module.VelocityModule;

import java.util.UUID;
import java.util.concurrent.TimeUnit;

/**
 * Proxy exploit koruma modülü. Config key: "proxy-exploit-koruma"
 */
public class ProxyExploitModule extends VelocityModule {

    private TabCompleteFloodBlocker tabCompleteBlocker;
    private ChatSpamDetector chatSpamDetector;
    private CommandFloodBlocker commandFloodBlocker;
    private ServerSwitchAbuse serverSwitchAbuse;

    public ProxyExploitModule(AtomGuardVelocity plugin) {
        super(plugin, "proxy-exploit-koruma");
    }

    @Override
    public void onEnable() {
        int maxTabPerSec = getConfigInt("tab-complete-limit", 5);
        int maxChatPerSec = getConfigInt("sohbet-limit", 3);
        int maxChatRepeats = getConfigInt("tekrar-mesaj-limit", 5);
        int maxCmdPerSec = getConfigInt("komut-limit", 10);
        int maxSwitchPerMin = getConfigInt("sunucu-degistirme-limit", 10);

        tabCompleteBlocker = new TabCompleteFloodBlocker(maxTabPerSec);
        chatSpamDetector = new ChatSpamDetector(maxChatPerSec, maxChatRepeats);
        commandFloodBlocker = new CommandFloodBlocker(maxCmdPerSec);
        serverSwitchAbuse = new ServerSwitchAbuse(maxSwitchPerMin);

        plugin.getProxyServer().getScheduler()
            .buildTask(plugin, this::periodicCleanup)
            .repeat(5, TimeUnit.MINUTES)
            .schedule();
    }

    @Override
    public void onDisable() {}

    public boolean allowTabComplete(UUID playerId) {
        if (!enabled) return true;
        boolean allowed = tabCompleteBlocker.allowTabComplete(playerId);
        if (!allowed) {
            incrementBlocked();
            plugin.getStatisticsManager().increment("tab_complete_blocked");
        }
        return allowed;
    }

    public ChatSpamDetector.SpamCheckResult checkChat(UUID playerId, String message) {
        if (!enabled) return new ChatSpamDetector.SpamCheckResult(ChatSpamDetector.SpamType.NONE, "disabled");
        ChatSpamDetector.SpamCheckResult result = chatSpamDetector.check(playerId, message);
        if (result.isSpam()) {
            incrementBlocked();
            plugin.getStatisticsManager().increment("chat_spam_blocked");
        }
        return result;
    }

    public boolean allowCommand(UUID playerId, String command) {
        if (!enabled) return true;
        boolean allowed = commandFloodBlocker.allowCommand(playerId, command);
        if (!allowed) {
            incrementBlocked();
            plugin.getStatisticsManager().increment("command_flood_blocked");
        }
        return allowed;
    }

    public boolean allowServerSwitch(UUID playerId) {
        if (!enabled) return true;
        boolean allowed = serverSwitchAbuse.allowSwitch(playerId);
        if (!allowed) {
            incrementBlocked();
            plugin.getStatisticsManager().increment("server_switch_blocked");
        }
        return allowed;
    }

    public void onPlayerLeave(UUID playerId) {
        if (chatSpamDetector != null) chatSpamDetector.onPlayerLeave(playerId);
        if (serverSwitchAbuse != null) serverSwitchAbuse.onPlayerLeave(playerId);
    }

    private void periodicCleanup() {
        if (tabCompleteBlocker != null) tabCompleteBlocker.cleanup();
        if (chatSpamDetector != null) chatSpamDetector.cleanup();
        if (commandFloodBlocker != null) commandFloodBlocker.cleanup();
        if (serverSwitchAbuse != null) serverSwitchAbuse.cleanup();
    }
}
